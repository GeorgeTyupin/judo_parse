# Judo Tournament Data Parser

Парсер данных турниров по дзюдо для создания интернет-архива соревнований

## Цель проекта

Проект разработан для обработки **огромных массивов исторических данных** о турнирах по дзюдо из специально структурированных Excel-файлов. Основная задача — извлечение, нормализация и подготовка данных для последующей загрузки в PostgreSQL и создания веб-архива турниров по дзюдо.

### Этапы развития проекта:
1. **Текущий этап**: Парсинг Excel → Создание сводных таблиц
2. **Следующий этап**: Миграция данных в PostgreSQL
3. **Финальная цель**: Веб-платформа для поиска и анализа результатов турниров

---

## Основной функционал

### Парсер Excel
Ядро проекта — **кастомный парсер** сложноструктурированных Excel-файлов:

- **Многоуровневая структура данных**: Листы → Турниры → Весовые категории → Спортсмены
- **Динамический разбор таблиц**: Автоматическое определение границ таблиц по разделителям `"|"` и маркерам `"END"`
- **Интеллектуальная валидация**: Фильтрация служебных строк и пустых данных
- **Параллельная обработка**: Одновременная работа с несколькими файлами через goroutines

### Обработка данных

**Сводная таблица (Pivot Table)**
- Создание нормализованных записей с 22 полями данных
- Извлечение метаинформации о турнирах (тип, место, дата, пол)
- Разбивка составных полей (город/страна, весовые категории)

**Поиск дублей (Duplicates Detection)**
- 4 алгоритма поиска одних и тех же спортсменов:
  - **Тип 1**: Фамилия + Первая буква имени + Страна
  - **Тип 2**: Фамилия + Первая буква имени
  - **Тип 3**: Нечёткое совпадение фамилий (~90%)
  - **Тип 4**: Точное совпадение фамилий + различие в именах

**Транслитерация**
- Конвертация английских имён в русские
- 230+ правил замены с учётом специфики советских имён
- Обработка сложных сочетаний (`Kh→Х`, `Shch→Щ`, `sky→ский`)

**Географическая нормализация**
- Замена советских топонимов современными:
  ```
  Leningrad → St. Petersburg
  Frunze → Bishkek
  Kuibyshev → Samara
  ```

### Экспорт данных
- Excel (сводная таблица, таблица дублей)
- JSON (опционально, для отладки)

---

## Архитектура

Проект следует принципам **чистой архитектуры** с разделением ответственности по слоям:

```
judo/
├── cmd/parse/               # Точка входа приложения
│   └── main.go             # CLI интерфейс, выбор файлов
│
├── internal/
│   ├── app/                # Слой приложения
│   │   └── app.go         # Оркестрация сервисов, управление потоками
│   │
│   ├── models/             # Модели данных (Domain layer)
│   │   ├── judoka.go      # Модель спортсмена
│   │   ├── tournament.go  # Модель турнира
│   │   ├── note.go        # Модель записи в сводной таблице
│   │   └── excel_sheet.go # Структура листов Excel
│   │
│   ├── services/           # Бизнес-логика
│   │   ├── pivot/         # Создание сводной таблицы
│   │   │   └── pivot.go
│   │   └── duplicates/    # Поиск дублей
│   │       ├── duplicates.go
│   │       └── dupfind/
│   │           └── search.go  # Алгоритмы поиска дублей
│   │
│   ├── parse/              # Парсинг исходных данных
│   │   └── parse.go       # Логика чтения Excel файлов
│   │
│   ├── io/                 # Слой ввода-вывода
│   │   ├── excel/
│   │   │   ├── parse/     # Запись сводной таблицы
│   │   │   └── duplicates/ # Запись таблицы дублей
│   │   └── json/
│   │       └── writer.go  # Экспорт в JSON
│   │
│   └── lib/                # Утилиты и вспомогательные функции
│       ├── replacers/
│       │   ├── transliterate.go  # Транслитерация имён
│       │   └── cities.go         # Нормализация городов
│       └── utils/
│           └── note/
│               └── note.go       # Утилиты для работы с записями
│
└── configs/
    └── .env               # Конфигурация (режим разработки)
```

### Взаимодействие слоёв

```
┌─────────────┐
│   main.go   │  CLI интерфейс (выбор файлов, параметры)
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   app.go    │  Оркестрация (запуск сервисов, goroutines)
└──────┬──────┘
       │
       ├──────────────────┬──────────────────┬─────────────────┐
       ▼                  ▼                  ▼                 ▼
┌──────────┐      ┌──────────────┐   ┌──────────────┐   ┌──────────┐
│ parse.go │      │ pivot.go     │   │duplicates.go │   │ json.go  │
│  (читает │      │ (обрабатывает│   │ (ищет дубли) │   │(экспорт) │
│  Excel)  │  ──> │  данные)     │   │              │   │          │
└──────────┘      └──────┬───────┘   └──────┬───────┘   └──────────┘
                         │                  │
                         ▼                  ▼
                  ┌──────────────┐   ┌──────────────┐
                  │ excel/parse/ │   │excel/duplica-│
                  │ (запись      │   │tes/ (запись  │
                  │  результата) │   │  дублей)     │
                  └──────────────┘   └──────────────┘
```

### Ключевые принципы

1. **Разделение ответственности**: Каждый модуль решает одну задачу
2. **Dependency Injection**: Сервисы не зависят от конкретных реализаций
3. **Параллелизм**: Использование goroutines для независимых операций
4. **Defer для гарантированного сохранения**: `defer service.File.SaveTable()`

---

## Технический стек

- **Go 1.25.1**
- **[excelize/v2](https://github.com/xuri/excelize)** — работа с Excel (XLSX)
- **[godotenv](https://github.com/joho/godotenv)** — управление конфигурацией
- **[go-deepcopy](https://github.com/tiendc/go-deepcopy)** — глубокое копирование структур

---

## Установка и запуск

### Требования
- Go 1.25.1+
- Excel файлы с турнирами в корне проекта

### Установка зависимостей
```bash
go mod download
```

### Конфигурация
Создайте файл `configs/.env`:
```env
IS_DEV=true  # Автоматический выбор параметров для разработки
```

### Запуск
```bash
go run cmd/parse/main.go
```

**Интерактивный режим:**
```
Выбор исходного файла. Введи:
1, если исходный USSR_tours
2, если исходный INT_tours
3, если оба
> 1

Проверять на дубли. Y/n
> y
```

**Режим разработки** (при `IS_DEV=true`):
- Автоматически выбирается файл USSR_tours
- Поиск дублей отключён

### Результаты
После выполнения создаются файлы:
- `Сводная таблица.xlsx` — нормализованные данные
- `Дубли.xlsx` — найденные дубликаты (если включено)
- `*.json` — JSON дамп (если `createJSON = true`)

---

## Примеры данных

### Входные данные (Excel)
```
| Rank | Name    | FirstName | JUDOKA           | SO   | Country |
|------|---------|-----------|------------------|------|---------|
| 1    | Ivanov  | Alexander | Ivanov Alexander | 1960 | Russia  |
| 2    | Petrov  | Sergey    | Petrov Sergey    | 1962 | USSR    |
```

### Выходные данные (Сводная таблица)
```
TOURNAMENT | TOUR_TYPE | TOUR_CITY | DATE       | GENDER | WC    | NAME   | JUDOKA_RUS        | ...
-----------|-----------|-----------|------------|--------|-------|--------|-------------------|----
Чемпионат  | Кубок     | Moscow    | 12.05.1985 | Men    | -60kg | Ivanov | Иванов Александр  | ...
```

---

## Производительность

- **Параллельная обработка**: Использование goroutines для одновременной записи в Excel и JSON
- **Эффективный парсинг**: Одна итерация по строкам для определения структуры
- **Отложенное сохранение**: Накопление записей в памяти с финальной записью через `defer`

Типичное время обработки: **<5 секунд** для файла с 10,000+ записями

---

## Лицензия

Частный проект. Все права защищены.
