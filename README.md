# Judo Tournament Data Parser

Парсер данных турниров по дзюдо для создания интернет-архива соревнований

## Цель проекта

Проект разработан для обработки **огромных массивов исторических данных** о турнирах по дзюдо из специально структурированных Excel-файлов. Основная задача — извлечение, нормализация и подготовка данных для последующей загрузки в PostgreSQL и создания веб-архива турниров по дзюдо.

### Этапы развития проекта:
1. **Текущий этап**: Парсинг Excel → Создание сводных таблиц
2. **Следующий этап**: Миграция данных в PostgreSQL
3. **Финальная цель**: Веб-платформа для поиска и анализа результатов турниров

---

## Основной функционал

### Парсер Excel
Ядро проекта — **кастомный парсер** сложноструктурированных Excel-файлов:

- **Многоуровневая структура данных**: Листы → Турниры → Весовые категории → Спортсмены
- **Динамический разбор таблиц**: Автоматическое определение границ таблиц по разделителям `"|"` и маркерам `"END"`
- **Интеллектуальная валидация**: Фильтрация служебных строк и пустых данных
- **Параллельная обработка**: Одновременная работа с несколькими файлами через goroutines

### Обработка данных

**Сводная таблица (Pivot Table)**
- Создание нормализованных записей с 22 полями данных
- Извлечение метаинформации о турнирах (тип, место, дата, пол)
- Разбивка составных полей (город/страна, весовые категории)

**Поиск дублей (Duplicates Detection)**
- 4 алгоритма поиска одних и тех же спортсменов с использованием расстояния Левенштейна:
  - **Тип 1**: Фамилия + Первая буква имени + Страна (для кратких имён ≤2 символов)
  - **Тип 2**: Фамилия + Первая буква имени (для кратких имён ≤2 символов)
  - **Тип 3**: Нечёткое совпадение фамилий (схожесть ≥90% по Левенштейну)
  - **Тип 4**: Точное совпадение фамилий + различие в именах (схожесть ≥90%)
- Инкапсуляция состояния в структуре `DuplicateFinder`
- Накопление уникальных спортсменов для сравнения

**Транслитерация**
- Конвертация английских имён в русские
- 230+ правил замены с учётом специфики советских имён
- Обработка сложных сочетаний (`Kh→Х`, `Shch→Щ`, `sky→ский`)

**Географическая нормализация**
- Замена советских топонимов современными:
  ```
  Leningrad → St. Petersburg
  Frunze → Bishkek
  Kuibyshev → Samara
  ```

### Экспорт данных
- Excel (сводная таблица, таблица дублей)
- JSON (опционально, для отладки)

---

## Архитектура

Проект следует принципам **чистой архитектуры** с разделением ответственности по слоям:

```
judo/
├── cmd/parse/               # Точка входа приложения
│   └── main.go             # CLI интерфейс, выбор файлов
│
├── internal/
│   ├── app/                # Слой приложения
│   │   └── app.go         # Оркестрация сервисов, управление потоками, DI
│   │
│   ├── interfaces/         # Общие интерфейсы
│   │   └── writer.go      # Интерфейс Writer для всех writers
│   │
│   ├── models/             # Модели данных (Domain layer)
│   │   ├── judoka.go      # Модель спортсмена
│   │   ├── tournament.go  # Модель турнира
│   │   ├── note.go        # Модель записи в сводной таблице
│   │   └── excel_sheet.go # Структура листов Excel
│   │
│   ├── services/           # Бизнес-логика
│   │   ├── parse/         # Сервис парсинга Excel
│   │   │   └── parse.go   # ParseService с Reader
│   │   ├── pivot/         # Создание сводной таблицы
│   │   │   └── pivot.go   # PivotService с DI writers
│   │   └── duplicates/    # Поиск дублей
│   │       ├── duplicates.go  # DuplicateService с DI writers
│   │       └── dupfind/
│   │           ├── search.go  # DuplicateFinder - структура поиска
│   │           └── types.go   # CheckType1-4 - функции проверки типов
│   │
│   ├── io/                 # Слой ввода-вывода
│   │   ├── excel/
│   │   │   ├── parse/     # Excel I/O для парсинга
│   │   │   │   ├── reader.go   # ExcelReader (чтение файлов)
│   │   │   │   └── writer.go   # ExcelWriter (сводная таблица)
│   │   │   └── duplicates/     # Excel I/O для дублей
│   │   │       └── writer.go   # ExcelWriter (таблица дублей)
│   │   └── json/
│   │       └── writer.go  # JsonWriter (экспорт в JSON)
│   │
│   └── lib/                # Утилиты и вспомогательные функции
│       ├── replacers/
│       │   ├── transliterate.go  # Транслитерация имён
│       │   └── cities.go         # Нормализация городов
│       └── utils/
│           ├── note/
│           │   └── note.go       # Утилиты для работы с записями
│           └── parse/
│               └── parseutils.go # Утилиты парсинга (ReNum, IsValidDataRow)
│
└── configs/
    └── .env               # Конфигурация (режим разработки)
```

### Взаимодействие слоёв

```
┌─────────────┐
│   main.go   │  CLI интерфейс (выбор файлов, параметры)
└──────┬──────┘
       │
       ▼
┌──────────────────────────────────────────────────────────┐
│                       app.go                             │
│  • Создаёт ParseService с массивом файлов               │
│  • Регистрирует Writers в сервисах через DI             │
│  • Запускает обработку в горутинах                      │
└──────┬───────────────────────────────────────────────────┘
       │
       ├─────────────────┬──────────────────┬──────────────┐
       ▼                 ▼                  ▼              ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐
│ ParseService │  │ PivotService │  │DuplicateSvc  │  │JsonWriter│
│              │  │              │  │              │  │          │
│ • Reader     │  │ • Writers[]  │  │ • Writers[]  │  │(опционал)│
│ • ParseTour  │  │ • ProcessData│  │ • ProcessData│  │          │
│   naments()  │  │ • RegisterW  │  │ • RegisterW  │  │          │
└──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └────┬─────┘
       │                 │                 │               │
       │ возвращает      │ внедрённые      │ внедрённые    │
       │ данные          │ writers:        │ writers:      │
       │                 │                 │               │
       ▼                 ▼                 ▼               ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐
│  Reader.go   │  │ExcelWriter   │  │ExcelWriter   │  │JsonWriter│
│              │  │(pivot)       │  │(duplicates)  │  │          │
│• Read()      │  │• Write(any)  │  │• Write(any)  │  │• Write() │
│• map[sheet]  │  │• SaveFile()  │  │• SaveFile()  │  │• SaveFile│
│  [][]string  │  │              │  │              │  │  ()      │
└──────────────┘  └──────────────┘  └──────────────┘  └──────────┘

Интерфейс Writer:
  type Writer interface {
    Write(data any)
    SaveFile()
  }
```

### Ключевые принципы

1. **Разделение ответственности**: Каждый модуль решает одну задачу
2. **Dependency Injection**: Сервисы получают Writers через `RegisterWriter()`
3. **Interface-based design**: Все writers реализуют интерфейс `interfaces.Writer`
4. **Type-safe operations**: Type assertions с проверкой `ok` в каждом writer
5. **Константы для ключей**: `ExcelWriterKey`, `JsonWriterKey` вместо magic strings
6. **Параллелизм**: Использование goroutines для независимых операций записи
7. **Defer для гарантированного сохранения**: `defer pivotService.Writers[key].SaveFile()`

---

## Технический стек

- **Go 1.25.1**
- **[excelize/v2](https://github.com/xuri/excelize)** — работа с Excel (XLSX)
- **[godotenv](https://github.com/joho/godotenv)** — управление конфигурацией
- **[go-deepcopy](https://github.com/tiendc/go-deepcopy)** — глубокое копирование структур
- **[go-edlib](https://github.com/hbollon/go-edlib)** — вычисление схожести строк (расстояние Левенштейна)

---

## Установка и запуск

### Требования
- Go 1.25.1+
- Excel файлы с турнирами в корне проекта

### Установка зависимостей
```bash
go mod download
```

### Конфигурация
Создайте файл `configs/.env`:
```env
IS_DEV=true  # Автоматический выбор параметров для разработки
```

### Запуск
```bash
go run cmd/parse/main.go
```

**Интерактивный режим:**
```
Выбор исходного файла. Введи:
1, если исходный USSR_tours
2, если исходный INT_tours
3, если оба
> 1

Проверять на дубли. Y/n
> y
```

**Режим разработки** (при `IS_DEV=true`):
- Автоматически выбирается файл USSR_tours
- Поиск дублей отключён

### Результаты
После выполнения создаются файлы:
- `Сводная таблица.xlsx` — нормализованные данные
- `Дубли.xlsx` — найденные дубликаты (если включено)
- `*.json` — JSON дамп (если `createJSON = true`)

---

## Примеры данных

### Входные данные (Excel)
```
| Rank | Name    | FirstName | JUDOKA           | SO   | Country |
|------|---------|-----------|------------------|------|---------|
| 1    | Ivanov  | Alexander | Ivanov Alexander | 1960 | Russia  |
| 2    | Petrov  | Sergey    | Petrov Sergey    | 1962 | USSR    |
```

### Выходные данные (Сводная таблица)
```
TOURNAMENT | TOUR_TYPE | TOUR_CITY | DATE       | GENDER | WC    | NAME   | JUDOKA_RUS        | ...
-----------|-----------|-----------|------------|--------|-------|--------|-------------------|----
Чемпионат  | Кубок     | Moscow    | 12.05.1985 | Men    | -60kg | Ivanov | Иванов Александр  | ...
```

---

## Производительность

- **Параллельная обработка**: Использование goroutines для одновременной записи в Excel и JSON
- **Эффективный парсинг**: Одна итерация по строкам для определения структуры
- **Отложенное сохранение**: Накопление записей в памяти с финальной записью через `defer`

Типичное время обработки: **<5 секунд** для файла с 10,000+ записями

---

## Лицензия

Частный проект. Все права защищены.
